{% extends 'layout.html' %}

{% block content %}
<h2 class="text-2xl font-bold mb-6 text-center text-gray-800">üåç Live Global Air Traffic Map</h2>

<div class="bg-white rounded-lg shadow-lg border border-gray-200 p-4 relative">
    <div id="map" class="w-full h-[600px] rounded-lg"></div>

    <!-- Loading Spinner -->
    <div id="loading" class="absolute inset-0 bg-white bg-opacity-80 flex flex-col items-center justify-center z-10">
        <svg class="animate-spin h-8 w-8 text-blue-600 mb-2" xmlns="http://www.w3.org/2000/svg" fill="none"
             viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
        <p class="text-sm text-gray-600">Loading flight data...</p>
    </div>
</div>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-sA+e2UDTUiIRF3mI0O/2dxd6dkhOCi/hMmn5jwCbN7w=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-p9w+UcTg+ZKkMyt6IY1OdBGLvM0gJFrjAw4iQlG4bQA=" crossorigin=""></script>

<script>
    const map = L.map('map').setView([20, 0], 2);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 10,
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let markers = [];

    function loadFlights() {
        fetch('/all-flights')
            .then(response => response.json())
            .then(data => {
                console.log("Flight data received:", data);

                const loadingEl = document.getElementById('loading');
                if (data.length === 0) {
                    loadingEl.innerHTML = `<p class="text-yellow-600 text-sm">No flight data available.</p>`;
                    return;
                }

                loadingEl.style.display = 'none';
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];

                data.forEach(flight => {
                    if (flight.latitude && flight.longitude) {
                        const marker = L.marker([flight.latitude, flight.longitude])
                            .addTo(map)
                            .bindPopup(`
                                <strong>${flight.callsign || "N/A"}</strong><br>
                                ICAO24: ${flight.icao24}<br>
                                Country: ${flight.origin_country}
                            `);
                        markers.push(marker);
                    }
                });
            })
            .catch(error => {
                console.error("Error loading flights:", error);
                document.getElementById('loading').innerHTML =
                    `<p class="text-red-600 text-sm">Failed to load flight data.</p>`;
            });
    }

    loadFlights();
    setInterval(loadFlights, 30000);
</script>
{% endblock %}
